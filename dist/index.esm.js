import t from"axios";const e=["/rest/data/v2.0/scripts","/rest/metadata/v2.0/dx/logic/extpoints/openapi","/rest/data/v2.0/xobjects","/rest/data/v2/query","/rest/metadata/v2.0/xobjects/filter"],s=async s=>{try{const a={...s,method:s?.method||"GET",data:s?.data||{},headers:{"xsy-inner-source":"neo-open-api","Content-Type":"application/json",...s?.headers},timeout:s?.timeout||3e4};if(!(t=>{if("undefined"==typeof window)return e.includes(t);let s,a;try{if(t.startsWith("http://")||t.startsWith("https://")){const e=new URL(t);s=e.origin,a=e.pathname}else s=window.location.origin,a=t.split("?")[0];return s!==window.location.origin||(!!e.some(t=>a===t||a.startsWith(t+"/"))||(console.warn(`不允许使用当前接口: ${a}。`),!1))}catch(s){return console.warn("API 地址解析失败，使用简单白名单检查:",s),e.includes(t)}})(a.url))throw new Error("不允许使用的平台数据接口: "+a.url);"GET"===a?.method&&(a.params=s?.data||{});const o=await t(a);return o?.data||{}}catch(t){throw t.response?console.error("接口请求报错 / 接口服务异常：",t.message):t.request?console.error("接口请求报错 / 接口未正常响应：",t.message):console.error("接口请求报错:",t,"，请求参数:",s),t}},a={query:async t=>{const e=t||{},a=e.xObjectApiKey||"",o=Object.assign([],e.fields||[]),r=e.page||1,c=e.pageSize||10;o.includes("id")||o.push("id");const d=(r-1)*c;let n=`select ${o.join(",")} from ${a}`;e.orderBy&&(n+=` order by ${e.orderBy}`),(e.page||e.pageSize)&&(n+=` limit ${d},${c}`);try{const t={url:"/rest/data/v2/query",method:"GET",data:{q:n}},e=await s(t);if(200===e.code){const{records:t,totalSize:s}=e.result||{};return{status:!0,code:e.code,msg:e.msg||"获取业务对象数据列表成功",totalSize:s,data:t||[]}}return{status:!1,code:e.code,msg:e.msg||"获取业务对象数据列表失败",data:[]}}catch(t){return console.error("获取业务对象数据列表失败:",t),{status:!1,msg:t.msg||t.message||"获取业务对象数据列表失败",data:[]}}},getEntityTypeList:async(t,e)=>{const a=e||{},o=`/rest/data/v2.0/xobjects/${t}/busiType`;try{const t={...a,url:o,method:"GET"},e=await s(t);if(200===e.code||"200"===e.code){const{records:t,totalSize:s}=e.data||{};return{status:!0,code:e.code,msg:e.msg||"获取业务类型列表成功",totalSize:s,data:t||[]}}return{status:!1,code:e.code,msg:e.msg||"获取业务类型列表失败",data:[]}}catch(t){return console.error("获取业务类型列表失败:",t),{status:!1,msg:t.msg||t.message||"获取业务类型列表失败",data:[]}}},getEntityList:async t=>{const e=t||{},a=e.active??!0,o=e.custom;let r=`/rest/metadata/v2.0/xobjects/filter?active=${a}`;void 0!==o&&(r=`/rest/metadata/v2.0/xobjects/filter?custom=${o}&active=${a}`);try{const t={...e,url:r,method:"GET"},a=await s(t);if("0"===a.code||0===a.code||"200"===a.code||200===a.code){const{records:t,totalSize:e}=a.data||{};return{status:!0,code:a.code,msg:a.msg||"获取对象列表成功",totalSize:e,data:t||[]}}return{status:!1,code:a.code,msg:a.msg||"获取对象列表失败",data:[]}}catch(t){return console.error("获取对象列表失败:",t),{status:!1,msg:t.msg||t.message||"获取对象列表失败",data:[]}}},getDesc:async(t,e)=>{const a=e||{},o=`/rest/data/v2.0/xobjects/${t}/description`;try{const t={...e,url:o,method:a.method||"GET"},r=await s(t);return"200"===r.code||200===r.code?{status:!0,code:r.code,msg:r.msg||"获取业务对象描述数据成功",data:r.data||{}}:{status:!1,code:r.code,msg:r.msg||"获取业务对象描述数据失败",data:{}}}catch(t){return console.error("获取业务对象描述数据失败:",t),{status:!1,msg:t.msg||t.message||"获取业务对象描述数据失败",data:{}}}},create:async(t,e)=>{const a=e||{},o=`/rest/data/v2.0/xobjects/${t}`,r=a.data||{};try{const t={...e,url:o,method:a.method||"POST",data:{data:r}},c=await s(t);return"200"===c.code||200===c.code?{status:!0,code:c.code,msg:c.msg||"创建业务数据成功",data:c.data||{}}:{status:!1,code:c.code,msg:c.msg||"创建业务数据失败",data:{}}}catch(t){return console.error("创建业务数据失败:",t),{status:!1,msg:t.msg||t.message||"创建业务数据失败",data:{}}}},update:async(t,e,a)=>{const o=a||{},r=`/rest/data/v2.0/xobjects/${t}/${e}`,c=o.data||{};try{const t={...o,url:r,method:o.method||"PATCH",data:{data:c}},e=await s(t);return"200"===e.code||200===e.code?{status:!0,code:e.code,msg:e.msg||"更新业务数据成功",data:e.data||{}}:{status:!1,code:e.code,msg:e.msg||"更新业务数据失败",data:{}}}catch(t){return console.error("更新业务数据失败:",t),{status:!1,msg:t.msg||t.message||"更新业务数据失败",data:{}}}},get:async(t,e,a)=>{let o=t,r=e,c=a||{};"object"==typeof t&&t.xObjectApiKey&&(c=t.options||{},r=t.objectId,o=t.xObjectApiKey);const d=`/rest/data/v2.0/xobjects/${o}/${r}`;try{const t={...c,url:d,method:c.method||"GET"},e=await s(t);return"200"===e.code||200===e.code?{status:!0,code:e.code,msg:e.msg||"获取业务数据成功",data:e.data||{}}:{status:!1,code:e.code,msg:e.msg||"获取业务数据失败",data:{}}}catch(t){return console.error("获取业务数据失败:",t),{status:!1,msg:t.msg||t.message||"获取业务数据失败",data:{}}}},delete:async(t,e,a)=>{const o=a||{},r=`/rest/data/v2.0/xobjects/${t}/${e}`;try{const t={...o,url:r,method:o.method||"DELETE"},e=await s(t);return"200"===e.code||200===e.code?{status:!0,code:e.code,msg:e.msg||"删除业务数据成功"}:{status:!1,code:e.code,msg:e.msg||"删除业务数据失败"}}catch(t){return console.error("删除业务数据失败:",t),{status:!1,msg:t.msg||t.message||"删除业务数据失败"}}}},o={getList:async t=>{const e=t||{},a=`/rest/metadata/v2.0/dx/logic/extpoints/openapi?pageNo=${e.pageNo||1}&pageSize=${e.pageSize||1e3}`;try{const t={url:a,method:"GET"},e=await s(t);if("0"===e.code||0===e.code||"200"===e.code||200===e.code){const{items:t,count:s}=e.data||{};return{status:!0,code:e.code,msg:e.msg||"获取自定义API列表成功",totalSize:s,data:t||[]}}return{status:!1,code:e.code,msg:e.msg||"获取自定义API列表失败",data:[]}}catch(t){return console.error("获取自定义API列表失败:",t),{status:!1,msg:t.msg||t.message||"获取自定义API列表失败",data:[]}}},run:async t=>{const e=t||{},a=e.apiUrl||"",o=e.methodType||e.method||"POST",r=e.data||{};try{const e={...t,url:a,method:o,data:r};return{status:!0,...await s(e)}}catch(t){return console.error("执行自定义API失败:",t),{status:!1,msg:t.msg||t.message||"执行自定义API失败",data:{}}}}},r=s;export{s as axiosFetcher,o as customApi,r as request,a as xObject};
